{"version":3,"sources":["user_file_upload_b64.1.js"],"names":["ctx","data","response","name","file","bucket_name","region","args","user","meta","Error","indexOf","fileValue","Buffer","from","split","s3instance","fullName","id","putObject","Body","Bucket","Key","ACL","err","json","link","error","message"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;;;;;;+BACe,WAAMA,GAAN,EAAa;AAC1B,UAAM,EAACC,IAAD,EAAOC,QAAP,KAAmB,6BAAOF,GAAP,CAAzB;AACA,QAAI;AACF,YAAM,EAACG,IAAD,EAAOC,IAAP,EAAaC,WAAb,EAA0BC,MAA1B,KAAoCN,IAAIO,IAA9C;AACA,YAAM,EAACC,IAAD,KAASR,IAAIS,IAAnB;AACA,UAAI,OAAOD,IAAP,KAAgB,WAApB,EAAiC;AAC/B,cAAM,IAAIE,KAAJ,CACJ,gEADI,CAAN;AAGD;;AAED,UAAGP,KAAKQ,OAAL,CAAa,GAAb,MAAsB,CAAC,CAA1B,EAA6B;AAC3B,cAAM,IAAID,KAAJ,CAAU,gCAAV,CAAN;AACD;AACD,YAAME,YAAYC,OAAOC,IAAP,CAAYV,KAAKW,KAAL,CAAW,GAAX,EAAgB,CAAhB,CAAZ,EAAgC,QAAhC,CAAlB;AACA,YAAMC,aAAa,iBAAG,EAAChB,GAAD,EAAMM,MAAN,EAAH,CAAnB;AACA,YAAMW,WAAY,GAAET,KAAKU,EAAG,IAAGf,IAAK,EAApC;AACAa,iBAAWG,SAAX,CACE;AACEC,cAAMR,SADR;AAEES,gBAAQhB,WAFV;AAGEiB,aAAKL,QAHP;AAIEM,aAAK;AAJP,OADF,EAOE,UAAUC,GAAV,EAAevB,IAAf,EAAqB;AACnB,YAAIuB,GAAJ,EAAS;AACP,iBAAOtB,SAASuB,IAAT,CAAc,EAACD,GAAD,EAAd,EAAqB,GAArB,CAAP;AACD,SAFD,MAEO;AACL,iBAAOtB,SAASuB,IAAT,CAAc;AACnBxB,gBADmB;AAEnByB,kBAAO,cAAapB,MAAO,kBAAiBD,WAAY,IAAGY,QAAS;AAFjD,WAAd,CAAP;AAID;AACF,OAhBH;AAkBD,KAjCD,CAiCE,OAAOU,KAAP,EAAc;AACd,aAAOzB,SAASuB,IAAT,CAAcE,MAAMC,OAApB,EAA6B,GAA7B,CAAP;AACD;AACF,G","file":"user_file_upload_b64.1.js","sourcesContent":["import Server from 'syncano-server'\nimport AWS from 'aws-sdk'\nimport s3 from './helpers/s3'\nexport default async ctx => {\n  const {data, response} = Server(ctx)\n  try {\n    const {name, file, bucket_name, region} = ctx.args\n    const {user} = ctx.meta\n    if (typeof user === 'undefined') {\n      throw new Error(\n        'You must be logged in to read or upload files to this endpoint'\n      )\n    }\n\n    if(name.indexOf(\"/\") !== -1 ){\n      throw new Error(\"You are not allowed to do that\")\n    }\n    const fileValue = Buffer.from(file.split(',')[1], 'base64')\n    const s3instance = s3({ctx, region})\n    const fullName = `${user.id}/${name}`\n    s3instance.putObject(\n      {\n        Body: fileValue,\n        Bucket: bucket_name,\n        Key: fullName,\n        ACL: 'private'\n      },\n      function (err, data) {\n        if (err) {\n          return response.json({err}, 400)\n        } else {\n          return response.json({\n            data,\n            link: `https://s3.${region}.amazonaws.com/${bucket_name}/${fullName}`\n          })\n        }\n      }\n    )\n  } catch (error) {\n    return response.json(error.message, 400)\n  }\n}\n"]}